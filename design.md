# 仕様(ver1.2:製品単価計算を受け簡易P/Lまで)
## 材料勘定(ver0.1で実装)
- 基本的発想（ver1）
  - 取引ごとに入力シートに記帳→月末一括処理
  - 在庫評価：移動平均法
  - 実際原価計算
  - 1種の製品を製造している
  - 当面払出額のすべてが直接費（仕掛品勘定へ）と考える
    - 仕訳との関連を持たせることができれば間接費との配賦が可能になる。

- 入力スプレッドシート列名：
  - 取引番号  入力規則: 1以上の整数
  - 日付  入力規則: 日付  ok
  - 材料コード（or 材料名）
  - 数量        （入庫：＋／払出：－）  入力規則: 0以外の数
  - 単価        （※入庫時のみ入力、払出時は空白）
  - 金額        （自動計算：数量×単価 ※入庫行のみ）
  - 摘要

- gasの役割
  - GASで：
    - 在庫数量を累積
    - 移動平均単価を内部計算
    - 払出原価を算出
    - 材料費合計を集計

- 在庫数・在庫価格は出力シートで表示
  - 入力シート：事実のみ
  - 集計シート:ver0.1では仕掛品勘定へ全額（直接費扱い）：T勘定要素を材料名ごとに集計。以下のそれぞれについて数量と金額を表示
    - 前月繰越（当面スクリプト内で直接指定。今後期を跨ぐ際の処理を実装予定。）
    - 当月受入
    - 当月払出
    - 翌月繰越

- 出力: 仕掛品勘定へ
  - シート列名: 対象月	タイムスタンプ	status	材料名	前月繰越数量	前月繰越金額	当月受入数量	当月受入金額	当月払出数量	当月払出金額	翌月繰越数量	翌月繰越金額
  - 送信列: 対象月	振替元	金額

## 労務費勘定(ver0.2で実装)
- 基本的発想(ver1)
  - 勤怠簿から確定済月間勤怠が共有されている想定
  - 従業員に紐づいた時給が勤怠シート側で計算できる想定
  - 実際原価計算・1財生産（材料費と同じ）
  - 作業内容に製造/手待の区別を導入し、直接費用と間接費用に区別
  - 実務において作業時間は所与でないことを意識（簿記の教科書との違い）
- 入力スプレッドシート列名：
  - 日付：日付以外入らないよう統制
  - 職員氏名：プルダウンで入力
  - 作業時間：上限勤務時間内の数値
  - 作業内容：プルダウンで入力
  - 時給：作業員名と紐づけて自動入力
  - 金額：自動計算
- GASでの処理
  - 入力内容を1行ごとに走査
  - 作業内容が製造なら直接費用、手待なら間接費用に割り振って月間集計
    - 未払賃金を設計に入れていない理由：
      - 本ツールは原価計算を目的としており、勤怠が確定した時点で当月発生額を確定させる設計としているため。
- 出力
  - 列名: 対象月	タイムスタンプ	status	直接労務費	間接労務費
  - 送信:
    - 仕掛品勘定へ:  対象月	タイムスタンプ	status	直接労務費
    - 製造間接費勘定へ: 対象月	タイムスタンプ	status	間接労務費

## 製造間接費(ver0.3で実装)
- 基本的発想(ver1)
  - 間接費を一旦全部集め、月次で確定させる箱
- 入力:間接労務費（後で間接経費を追加予定）から転記。
  - 列名: 対象月	振替元	金額
- 処理:一財想定の間は集計のみ。（v2以降で2財以上製造するときに部門別集計、配賦等を導入予定）
- 出力:仕掛品勘定へ
  - 列名: 対象月	タイムスタンプ	status	金額

## 仕掛品勘定(v1)
- 基本的発想
  - 直接費・間接費をすべてここに集約。簡略化のため次期繰越はないものと考える。
  - 進捗による按分は扱わない。
- 入力：材料、(直接)労務費、製造間接費の各費目の確認が終われば自動転記される。
  - 列名：対象月	振替元	金額
- 処理：各費目を集約して出力シートへ。暫定的に製品名、当月製造数量は処理内で指定。
- 出力：確認後に製品勘定へ転記。
  - 列名：対象月	タイムスタンプ	status	製品名	前月繰越数量	前月繰越加工進捗	前月繰越金額	当月受入数量	当月受入金額	当月払出数量	当月払出金額	翌月繰越数量	翌月繰越加工進捗	翌月繰越金額
  - 転記列：対象月	振替元	金額	受入数量	製品名
    - 将来的な拡張を見越した配列。v1では事実上すべては使わない。

## 製品勘定(v1.1)
- 基本的発想
  - 仕掛品勘定からの受入をもとに総平均法で販売原価を算出
  - 在庫数量の整合性は v1.x の対象外
- 入力：仕掛品勘定で確認が終われば転記される。
  - 列名：対象月	振替元	金額	受入数量	製品名
- 処理：入力をもとに単価等を計算して出力シートへ。販売原価の計算は総平均法による。暫定的に前月繰越は処理内で指定。
- 出力： 
  - 列名：対象月	タイムスタンプ	status	製品名	前月繰越数量	前月繰越金額	当月受入数量	当月受入金額	当月払出数量	当月払出金額	翌月繰越数量	翌月繰越金額	当月製品原価(/個)
  - 転記列: 対象月	タイムスタンプ	製品名	当月製品原価(/個)
 
## 簡易P/L作成(v1.2)
- 入力: 
  - 売上シート:
    - 列名: 取引ID	製品名	日付	売上個数	売上単価	売上額(=個数×販売単価)
  - 原価情報: 製品勘定から
    - 列名: 対象月	タイムスタンプ	製品名	販売原価
- 処理:
  1. 売上集計: 集計シートへ(列名: 対象月	タイムスタンプ	status	製品名	売上数量	売上高)
  2. 上記列と原価情報から売上高と売上原価を算出
- 出力: P/L形式でスプレッドシート上に売上総利益を算出。

## 費目間処理形式の統一(ver1)
- 目的
  - 各勘定に処理方式の同型性とシート構成等による個別性が存在することを前提に、管理しやすく可読性の高い処理を行う。
- 構成
  - 各費目入力シートのB1セルを対象月入力セルとする。（下記共通管理仕様参照）
  - 集計フロー(共通関数: flowCalc_(ctx))
    - 入力：入力シート読み取り(勘定個別関数: ctx.loadInput_(targetMonth))
    - 処理：出力用二次元配列作成(勘定個別関数: ctx.aggregation_())
    - 出力：出力用シートに書き出し(勘定個別関数: ctx.fillInSs_())
  - 確認フロー(共通関数: flowCnfm_(ctx))
    - 入力：出力シートを読み取り(勘定個別関数: ctx.loadOutput_(targetMonth))
    - 処理：
      - confirmation(勘定個別関数: ctx.applyConfirmation_())
      - 次工程へ送信する配列を作成(勘定個別関数: ctx.contentToSend_())
    - 出力：
      - 出力用シートを更新(勘定個別関数: ctx.refreshSs_())
      - 次工程に送信(勘定個別関数: ctx.sendToNext_())
-  例
  -  executeXxx()        // UI・トリガー用  
    - └─ flow_xxx_()     // 処理段階（集計・確認など）  
      - └─ ctx.xxx     // 勘定差分（定数）  
        - └─ labor_xxx_() / material_xxx_()
 

## 共通管理仕様(ver1)
### 目的
- 原価計算各工程（材料費・労務費・製造間接費・仕掛品勘定）に共通する次の事項を行う。
  - 対象月管理
  - 状態管理
- これにより、月次処理の誤連鎖・二重計上を防き、担当者間の非同期作業を前提とした安全な受け渡しを実現する。
### 基本方針
- 各費目は 独立した集計単位 とする
- 他工程への数値連携は confirmed 状態のみ を対象とする
- GASは状態を「作る」だけで、「判断」は人が行う前提とする
### 対象月（Target Month）の管理
#### 定義
- 月次集計の対象期間を表すキー
- 書式：yyyy-MM（例：2025-12）
#### 管理方法
- 各集計シートのヘッダに明示的に入力する
- 日付列や取引日からの自動推定は行わない（ver1）
#### 入力仕様
- セル位置: B1（例）
- 入力方法: 手入力
- 入力制約: 正規表現 ^\d{4}-(0[1-9]|1[0-2])$
  - 日付への自動変換を切ったうえで上記の入力規則を導入
### 状態管理（Status）
#### 状態一覧
- draft: 入力中・再集計可能
- ready:	集計完了、確認待ち
- confirmed:	確定済、他勘定へ連携可
#### 状態遷移
- draft → ready → confirmed
  - confirmed から draft への戻しは不可（ver1）
  - 修正が必要な場合は 再集計（新行） で対応
### 集計結果の管理単位
#### 原則
- 「費目 × 対象月 × 状態」を1レコードとする
- confirmed 状態は**一意**でなければならない
#### confirmed 重複チェック
- 同一費目・同一対象月の confirmed が存在する場合：
  - 処理を停止
  - エラーメッセージを表示
  - 手動対応を促す
### GASの責務範囲
#### GASが行うこと
- 入力値の形式チェック
- 集計処理
- 状態の付与
- confirmed 状態のみを次工程へ連携
#### GASが行わないこと
- 月の正しさの判断
- 業務上の是非判断
- 担当者間の合意形成
### 担当者間連携（ver1）
#### 基本方針
- 状態遷移をもって「業務完了の合図」とする
- 通知は補助的機能（必須ではない）
#### 想定フロー例（労務費）
1. 労務費担当：集計 → ready
2. 確認後：confirmed
3. confirmed を検知して製造間接費へ連携
### 各費目への適用
- 材料費	必須	共通仕様
- 労務費	必須	共通仕様
- 製造間接費	必須	共通仕様
- 仕掛品勘定	必須	共通仕様
### ver2以降への拡張余地
- 状態の追加（reopened 等）
- confirmed 取消フロー
- 月跨ぎ集計（未払・見越）
- 自動通知・承認ワークフロー
